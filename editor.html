<!DOCTYPE html>
<html lang="kr">

<head>
    <meta charset="utf-8">
    <title>KBotHub</title>
    <link rel="shortcut icon" type="image/jpg" href="https://kboteditor.kro.kr/img/output-onlinepngtools.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kboteditor.kro.kr/">
    <meta property="og:title" content="KakaotalkBot Hub">
    <meta property="og:description" content="카카오톡 봇 허브입니다.">
    <meta property="og:image" content="https://kboteditor.kro.kr/img/grp_img.jpg">
    <meta name="description" content="봇 허브 입니다">
    <meta name="keywords" content="온라인 메신저봇">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://kboteditor.kro.kr/fonts/fonts.css">
    <link rel="stylesheet" href="https://kboteditor.kro.kr/css/Toast.min.css">
    <script src="https://kboteditor.kro.kr/js/Toast.min.js"></script>
</head>

<body>
    <div class="toastjs-container" role="alert" aria-hidden="true">
        <div class="toastjs"></div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-performance.js"></script>
    <div id="monaco_container"></div>
    <style>
        html,
        body,
        #monaco_container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .userDecoration {
            background-color: rgba(38 212 50 / 15%);
            color: white;
        }

        .lineHighlight {
            background-color: rgb(229 255 0 / 15%) !important;
        }
        
        .other-cursor {
            background: black;
            width: 2px !important;
            opacity: 50%;
        }
    </style>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyBsvjuWiZBTEoBJWMvih4q7JHH6gmHF1X0",
            authDomain: "editor-280309.firebaseapp.com",
            databaseURL: "https://editor-280309.firebaseio.com",
            projectId: "editor-280309",
            storageBucket: "editor-280309.appspot.com",
            messagingSenderId: "836598450292",
            appId: "1:836598450292:web:35d0ab7d3e13faf7bba921",
            measurementId: "G-RJNBM8TLLK"
        };

        firebase.initializeApp(firebaseConfig);
        firebase.performance();
        firebase.analytics();
        console.log('loaded firebase');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script>
        var editor;
        var _data = {
            firebase: false,
            queueRef: {},
            cursor: {},
            'project': {},
            db: {},
            user: {},
            update: {},
            language: ""
        };
        var applyingDeltas = false;
        var lastRef = Date.now().toString();
        var lastCursor = Date.now().toString();
        var lastUser = Date.now().toString();

        function init_firebase() {
            if (window.innerWidth < 350) {
                alert('mobile not supported');
                history.back();
                return;
            }
            if (!location.href.startsWith('https://kboteditor.kro.kr/editor?id=')) {
                _data = {
                    'project': {
                        'scriptName': '스크립트 이름'
                    },
                };
                _data.value = [
                    'const scriptName = \"' + _data.project.scriptName + '\";',
                    '/**',
                    ' * (string) room',
                    ' * (string) sender',
                    ' * (boolean) isGroupChat',
                    ' * (void) replier.reply(message)',
                    ' * (boolean) replier.reply(room, message, hideErrorToast = false) // 전송 성공시 true, 실패시 false 반환',
                    ' * (string) imageDB.getProfileBase64()',
                    ' * (string) packageName',
                    ' */',
                    'function response(room, msg, sender, isGroupChat, replier, imageDB, packageName) {',
                    '\t//여기에 코드를 입력',
                    '}',
                    '',
                    '//아래 4개의 메소드는 액티비티 화면을 수정할때 사용됩니다.',
                    'function onCreate(savedInstanceState, activity) {',
                    '\tvar textView = new android.widget.TextView(activity);',
                    '\ttextView.setText("Hello, World!");',
                    '\ttextView.setTextColor(android.graphics.Color.DKGRAY);',
                    '\tactivity.setContentView(textView);',
                    '}',
                    '',
                    'function onStart(activity) {}',
                    '',
                    'function onResume(activity) {}',
                    '',
                    'function onPause(activity) {}',
                    '',
                    'function onStop(activity) {}'
                ].join('\n');
                init_editor();
            } else if (location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split("#")[0].length != 10 || !(!isNaN(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0]) && isFinite(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0]) && Math.floor(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0]) == location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0])) {
                _data.value = '/*\ninvalid project id\n*/';
                init_editor();
            } else if (!firebase.database().ref("project_data").child(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0])) {
                _data.value = '/*\nproject does\'t exist\n*/';
                init_editor();
            } else {
                try {
                    _data.editor_id = location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0];
                    _data.project.db = firebase.database().ref("project_data").child(_data.editor_id);
                    _data.project.db.once('value').then(function(d) {
                        _data.db = d.val();
                        _data.value = decodeURIComponent(_data.db.content);
                        document.title = decodeURIComponent(_data.db.title);
                        if (_data.db.language == "js") {
                            _data.language = 'javascript';
                        }
                        init_editor();
                    });
                    _data.firebase = true;
                    _data.queueRef = _data.project.db.child("queue");
                    _data.cursor = _data.project.db.child("cursor");
                    _data.update = _data.project.db.child("update");
                } catch (e) {
                    _data.value = '/*\nunknown error\n' + e + '\n*/';
                    init_editor();
                }
            }
        }

        function init_editor() {
            var decorations = [];
            if (!_data.language) {
                _data.language = "javascript";
            }
            if (['javascript'].indexOf(_data.language) != -1) {
                require.config({
                    paths: {
                        'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.16.2/min/vs'
                    }
                });
                require(['vs/editor/editor.main'], function() {
                    editor = monaco.editor.create(document.getElementById('monaco_container'), {
                        value: _data.value,
                        language: _data.language,
                        theme: 'vs-dark',
                        fontFamily: 'JetBrainsMono-Regular',
                        automaticLayout: true
                    });
                    editor.createContextKey( /*key name*/ 'beautifier', /*default value*/ true);
                    editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_B, function() {
                        editor.getAction('editor.action.formatDocument').run()
                    }, 'beautifier');
                    if (location.href.substring(location.href.split('#')[0].length).startsWith('#L') && isFinite(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0])) && !isNaN(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]))) {
                        //L111 or L1-12 일때 이동, 하이라이팅
                        if (location.href.substring(location.href.split('#')[0].length + 2).split("-").length == 1) {
                            editor.revealPositionInCenter({
                                lineNumber: Number(location.href.substring(location.href.split('#')[0].length + 2)),
                                column: 1
                            });
                            editor.deltaDecorations([], [{
                                range: new monaco.Range(Number(location.href.substring(location.href.split('#')[0].length + 2)), 1, Number(location.href.substring(location.href.split('#')[0].length + 2)), editor.getValue().split('\n')[Number(location.href.substring(location.href.split('#')[0].length + 2) - 1)].length + 1),
                                options: {
                                    inlineClassName: 'lineHighlight'
                                }
                            }, ]);
                        } else if (location.href.substring(location.href.split('#')[0].length + 2).split("-").length == 2 && isFinite(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1])) && !isNaN(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1]))) {
                            if (Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]) < Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1])) {
                                editor.revealPositionInCenter({
                                    lineNumber: Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]),
                                    column: 1
                                });
                                editor.deltaDecorations([], [{
                                    range: new monaco.Range(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]), 1, Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1]), editor.getValue().split('\n')[Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1]) - 1].length + 1),
                                    options: {
                                        inlineClassName: 'lineHighlight'
                                    }
                                }, ]);
                            } else {
                                editor.revealPositionInCenter({
                                    lineNumber: Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1]),
                                    column: 1
                                });
                                editor.deltaDecorations([], [{
                                    range: new monaco.Range(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1]), 1, Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]), editor.getValue().split('\n')[Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]) - 1].length + 1),
                                    options: {
                                        inlineClassName: 'lineHighlight'
                                    }
                                }, ]);
                            }
                        }
                    }
                    console.log('loaded monaco');
                    if (_data.firebase) {
                        if (!!firebase.auth().currentUser) {
                            if (_data.db.type == "private") {
                                if (!!_data.db.owners[firebase.auth().currentUser.uid]) {
                                    _data.user = _data.project.db.child("owners");

                                    _data.project.db.once('value').then(function(d) {
                                        _data.db = d.val();
                                        if (_data.db.owners[firebase.auth().currentUser.uid]["online"] == true) {
                                            alert('동시 접속이 불가능합니다');
                                            history.back();
                                        }

                                        _data.user.child(firebase.auth().currentUser.uid).update({
                                            "online": true,
                                            "name": firebase.auth().currentUser.displayName,
                                            "proflie": firebase.auth().currentUser.photoURL,
                                            "email": firebase.auth().currentUser.email,
                                            "by": firebase.auth().currentUser.uid
                                        });
                                    });
                                    _data.user.update({
                                        online: _data.db.owners.online + "," + firebase.auth().currentUser.uid
                                    });
                                    _data.update.update({
                                        active: true
                                    });
                                    editor.onDidChangeModelContent(function(editor_value) {
                                        if (applyingDeltas) {
                                            return;
                                        }
                                        _data.project.db.update({
                                            content: encodeURIComponent(editor.getValue())
                                        });

                                        _data.queueRef.update({

                                            //timestamp
                                            ts: Date.now().toString() + ":" + Math.random().toString().slice(2),
                                            // Store the data we get from monaco editor
                                            event: editor_value,
                                            // Store the firebase-user id
                                            by: firebase.auth().currentUser.uid
                                        }).catch(function(e) {
                                            // In case of errors, we want to see them in the console
                                            console.error(e)
                                        });
                                    });
                                    editor.onDidChangeCursorSelection((value) => {
                                        if (applyingDeltas) {
                                            return;
                                        }
                                        _data.cursor.update({
                                            //timestamp
                                            ts: Date.now().toString() + ":" + Math.random().toString().slice(2),
                                            // Store the data we get from monaco editor
                                            event: value,
                                            // Store the editor value
                                            value: value.selection,
                                            // Store the firebase-user id
                                            by: firebase.auth().currentUser.uid
                                        }).catch(function(e) {
                                            // In case of errors, we want to see them in the console
                                            console.error(e)
                                        });
                                    });
                                    window.onbeforeunload = function() {
                                        _data.user.child(firebase.auth().currentUser.uid).update({
                                            "online": false
                                        });
                                        _data.user.once('value').then(function(d) {
                                            _data.user.update({
                                                online: d.val().online.replaceAll("," + firebase.auth().currentUser.uid, "")
                                            });
                                        });
                                        _data.project.db.update({
                                            content: encodeURIComponent(editor.getValue())
                                        });
                                    }
                                } else {
                                    editor.setValue("/*\nthis is a private project\n*/");
                                }
                            } else if (_data.db.type == "public") {
                                _data.user = _data.project.db.child("users");
                                if (!_data.db.users[firebase.auth().currentUser.uid]) {
                                    _data.user.child(firebase.auth().currentUser.uid).set({
                                        "online": false,
                                        "name": firebase.auth().currentUser.displayName,
                                        "proflie": firebase.auth().currentUser.photoURL,
                                        "email": firebase.auth().currentUser.email,
                                        "by": firebase.auth().currentUser.uid
                                    });
                                }
                                _data.project.db.once('value').then(function(d) {
                                    _data.db = d.val();
                                    if (_data.db.users[firebase.auth().currentUser.uid]["online"] == true) {
                                        alert('동시 접속이 불가능합니다');
                                        history.back();
                                    }

                                    _data.user.child(firebase.auth().currentUser.uid).update({
                                        "online": true,
                                        "name": firebase.auth().currentUser.displayName,
                                        "proflie": firebase.auth().currentUser.photoURL,
                                        "email": firebase.auth().currentUser.email,
                                        "by": firebase.auth().currentUser.uid
                                    });
                                });
                                _data.user.update({
                                    online: _data.db.users.online + "," + firebase.auth().currentUser.uid
                                });
                                _data.update.update({
                                    active: true
                                });
                                editor.onDidChangeModelContent(function(editor_value) {
                                    if (applyingDeltas) {
                                        return;
                                    }

                                    _data.queueRef.update({

                                        //timestamp
                                        ts: Date.now().toString() + ":" + Math.random().toString().slice(2),
                                        // Store the data we get from monaco editor
                                        event: editor_value,
                                        // Store the firebase-user id
                                        by: firebase.auth().currentUser.uid
                                    }).catch(function(e) {
                                        // In case of errors, we want to see them in the console
                                        console.error(e)
                                    });
                                });
                                editor.onDidChangeCursorSelection((value) => {
                                    if (applyingDeltas) {
                                        return;
                                    }
                                    _data.cursor.update({
                                        //timestamp
                                        ts: Date.now().toString() + ":" + Math.random().toString().slice(2),
                                        // Store the data we get from monaco editor
                                        event: value,
                                        // Store the editor value
                                        value: value.selection,
                                        // Store the firebase-user id
                                        by: firebase.auth().currentUser.uid
                                    }).catch(function(e) {
                                        // In case of errors, we want to see them in the console
                                        console.error(e)
                                    });
                                });
                                window.onbeforeunload = function() {
                                    _data.user.child(firebase.auth().currentUser.uid).update({
                                        "online": false
                                    });
                                    _data.user.once('value').then(function(d) {
                                        _data.user.update({
                                            online: d.val().online.replaceAll("," + firebase.auth().currentUser.uid, "")
                                        });
                                    });
                                    _data.project.db.update({
                                        content: encodeURIComponent(editor.getValue())
                                    });
                                }
                            }
                            _data.queueRef.on("child_changed", function(ref) {
                                _data.queueRef.once('value').then(function(d) {
                                    // Get the snapshot value
                                    var value = d.val();

                                    // Get the timestamp
                                    var timestamp = value.ts.split(":")[0];

                                    // Do not apply changes from the past
                                    if (lastCursor > timestamp) {
                                        return;
                                    }

                                    // In case it's me who changed the value, I am
                                    // not interested to see twice what I'm writing.
                                    // So, if the update is made by me, it doesn't
                                    // make sense to apply the update
                                    if (value.by === firebase.auth().currentUser.uid) {
                                        return;
                                    }

                                    // We're going to apply the changes by somebody else in our editor
                                    //  1. We turn applyingDeltas on
                                    applyingDeltas = true;
                                    //  2. Update the editor value with the event data
                                    //editor.setValue(decodeURIComponent(value.value));
                                    //value.event.changes.0.range.endColumn
                                    value = value.event.changes[0]
                                    editor.executeEdits("", [{
                                        range: new monaco.Range(value.range.startLineNumber, value.range.startColumn, value.range.endLineNumber, value.range.endColumn),
                                        text: value.text
                                    }]);
                                    //  3. Turn off the applyingDeltas
                                    applyingDeltas = false;
                                    //  4. Log the event to console
                                    console.log(value.event);

                                    lastRef = Date.now().toString();
                                });
                            });
                            _data.update.on("child_changed", function(ref) {
                                _data.update.once('value').then(function(d) {
                                    if (d.val().active == true) {
                                        _data.project.db.update({
                                            content: encodeURIComponent(editor.getValue())
                                        });
                                        _data.update.update({
                                            active: false
                                        });
                                    }
                                });
                            });
                            _data.cursor.on("child_changed", function(ref) {
                                _data.cursor.once('value').then(function(d) {
                                    var value = d.val();

                                    // Get the timestamp
                                    var timestamp = value.ts.split(":")[0];

                                    // Do not apply changes from the past
                                    if (lastCursor > timestamp) {
                                        return;
                                    }

                                    // In case it's me who changed the value, I am
                                    // not interested to see twice what I'm writing.
                                    // So, if the update is made by me, it doesn't
                                    // make sense to apply the update
                                    if (value.by === firebase.auth().currentUser.uid) {
                                        return;
                                    }

                                    // We're going to apply the changes by somebody else in our editor
                                    //  1. We turn applyingDeltas on
                                    applyingDeltas = true;
                                    //  2. Update the editor value with the event data
                                    decorations = editor.deltaDecorations(decorations, [{
                                        range: new monaco.Range(1, 1, 1, 1),
                                        options: {
                                            inlineClassName: 'userDecoration'
                                        }
                                    }]);
                                    if(value.value.startLineNumber<value.value.endLineNumber){
                                    decorations = editor.deltaDecorations(decorations, [
                                        //    1. highlight value.value.startLineNumber, value.value.startColumn to value.value.endLineNumber, value.value.endColumn with orange,green, etc.
                                        {
                                            range: new monaco.Range(value.value.startLineNumber, value.value.startColumn, value.value.endLineNumber, value.value.endColumn),
                                            options: {
                                                inlineClassName: 'userDecoration'
                                            }
                                        },
                                        //    2. show cursor at value.value.positionLineNumber, value.value.positionColumn
                                        {
                                            range: new monaco.Range(value.value.positionLineNumber, value.value.positionColumn, value.value.positionLineNumber, value.value.positionColumn),
                                            options: {
                                                className: 'other-cursor'
                                            }
                                        },
                                        //    3. show a name tag over it when it moves
                                    ]);
                                    }else{
                                    decorations = editor.deltaDecorations(decorations, [
                                        //    1. highlight value.value.startLineNumber, value.value.startColumn to value.value.endLineNumber, value.value.endColumn with orange,green, etc.
                                        {
                                            range: new monaco.Range(value.value.endLineNumber, value.value.endColumn, value.value.startLineNumber, value.value.startColumn),
                                            options: {
                                                inlineClassName: 'userDecoration'
                                            }
                                        },
                                        //    2. show cursor at value.value.positionLineNumber, value.value.positionColumn
                                        {
                                            range: new monaco.Range(value.value.positionLineNumber, value.value.positionColumn, value.value.positionLineNumber, value.value.positionColumn),
                                            options: {
                                                className: 'other-cursor'
                                            }
                                        },
                                        //    3. show a name tag over it when it moves
                                    ]);
                                    }
                                    //  3. Turn off the applyingDeltas
                                    applyingDeltas = false;
                                    //  4. Log the event to console
                                    console.log(value.event);

                                    lastCursor = Date.now().toString();
                                });
                            });
                            _data.user.on("child_changed", function(ref) {

                                // Get the timestamp
                                var timestamp = ref.key.split(":")[0];

                                // Do not apply changes from the past
                                if (lastUser > timestamp) {
                                    return;
                                }

                                // Get the snapshot value
                                var value = ref.val();

                                // In case it's me who changed the value, I am
                                // not interested to see twice what I'm writing.
                                // So, if the update is made by me, it doesn't
                                // make sense to apply the update
                                if (value.by === firebase.auth().currentUser.uid) {
                                    return;
                                }

                                if (value.online == true) {
                                    new Toast({
                                        message: value.name + " joined"
                                    })
                                } else if (value.online == false) {
                                    new Toast({
                                        message: value.name + " left"
                                    })
                                }

                                console.log(value)
                                lastUser = Date.now().toString()
                            });
                        }
                    }
                });
            }
        }
        init_firebase()
    </script>
</body>

</html>
