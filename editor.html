<!DOCTYPE html>
<html lang="kr">

<head>
    <meta charset="utf-8">
    <title>KBotHub</title>
    <link rel="shortcut icon" type="image/jpg" href="https://kboteditor.kro.kr/img/output-onlinepngtools.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kboteditor.kro.kr/">
    <meta property="og:title" content="KakaotalkBot Hub">
    <meta property="og:description" content="카카오톡 봇 허브입니다.">
    <meta property="og:image" content="https://kboteditor.kro.kr/img/grp_img.jpg">
    <meta name="description" content="봇 허브 입니다">
    <meta name="keywords" content="온라인 메신저봇">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://kboteditor.kro.kr/fonts/fonts.css">
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-firestore.js"></script>
</head>

<body>
    <div class="toastjs-container" role="alert" aria-hidden="true">
        <div class="toastjs"></div>
    </div>
    <div id="monaco_container"></div>
    <style>
        html,
        body,
        #monaco_container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyBsvjuWiZBTEoBJWMvih4q7JHH6gmHF1X0",
            authDomain: "editor-280309.firebaseapp.com",
            databaseURL: "https://editor-280309.firebaseio.com",
            projectId: "editor-280309",
            storageBucket: "editor-280309.appspot.com",
            messagingSenderId: "836598450292",
            appId: "1:836598450292:web:35d0ab7d3e13faf7bba921",
            measurementId: "G-RJNBM8TLLK"
        };

        firebase.initializeApp(firebaseConfig);

        console.log('loaded firebase');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script>
        var editor;
        var _data = {firebase: false, queueRef: {}, cursor: {}};
        var applyingDeltas = false;
        var lastRef;
        var lastCusor;
        function init_firebase() {
            if (!location.href.startsWith('https://kboteditor.kro.kr/editor?id=')) {
                _data = {
                    'project': {
                        'scriptName': '스크립트 이름'
                    },
                };
                _data.value = [
                    'const scriptName = \"' + _data.project.scriptName + '\";',
                    '/**',
                    ' * (string) room',
                    ' * (string) sender',
                    ' * (boolean) isGroupChat',
                    ' * (void) replier.reply(message)',
                    ' * (boolean) replier.reply(room, message, hideErrorToast = false) // 전송 성공시 true, 실패시 false 반환',
                    ' * (string) imageDB.getProfileBase64()',
                    ' * (string) packageName',
                    ' */',
                    'function response(room, msg, sender, isGroupChat, replier, imageDB, packageName) {',
                    '\t//여기에 코드를 입력',
                    '}',
                    '',
                    '//아래 4개의 메소드는 액티비티 화면을 수정할때 사용됩니다.',
                    'function onCreate(savedInstanceState, activity) {',
                    '\tvar textView = new android.widget.TextView(activity);',
                    '\ttextView.setText("Hello, World!");',
                    '\ttextView.setTextColor(android.graphics.Color.DKGRAY);',
                    '\tactivity.setContentView(textView);',
                    '}',
                    '',
                    'function onStart(activity) {}',
                    '',
                    'function onResume(activity) {}',
                    '',
                    'function onPause(activity) {}',
                    '',
                    'function onStop(activity) {}'
                ].join('\n');
                return;
            } else if (location.href.substring('https://kboteditor.kro.kr/editor?id='.length).length != 10 || !(!isNaN(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0]) && isFinite(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0]) && Math.floor(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0]) == location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0])) {
                _data.value = '/*\ninvalid project id\n*/';
                return;
            } else if ( !firebase.database().ref("project_data").child(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0]) ) {
                _data.value = '/*\nproject does\'t exist\n*/';
                return;
            } else {
                try {
                    _data.editor_id=location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0];
                    if(location.href.substring(location.href.split('#')[0].length).startsWith('#L')&&isFinite(location.href.substring(location.href.split('#')[0].length+2))&&!isNaN(location.href.substring(location.href.split('#')[0].length+2))){
                       //L111 or L1-12 일때 이동, 하이라이팅
                    }
                    _data.project.db=firebase.database().ref("project_data").child(_data.editor_id);
                    _data.project.db.once("value", function (database) {data.project.value=database.value()});
                    _data.value = decodeURIComponent(_data.project.db.content);
                    _data.firebase=true;
                    _data.queueRef = _data.project.db.child("queue");
                    _data.cursor = _data.project.db.child("cursor");
                    return;
                } catch (e) {
                    _data.value = '/*\nunknown error\n'+e+'\n*/';
                    return;
                }
            }
        }
        function init_editor(){
            require.config({
                paths: {
                    'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.16.2/min/vs'
                }
            });
            require(['vs/editor/editor.main'], function() {
                editor = monaco.editor.create(document.getElementById('monaco_container'), {
                    value: _data.value,
                    language: 'javascript',
                    theme: 'vs-dark',
                    fontFamily: 'JetBrainsMono-Regular',
                    automaticLayout: true
                });
                console.log('loaded monaco');
                if( _data.firebase&&!!firebase.auth().currentUser ){
                    if(!!_data.project.db.owners[firebase.auth().currentUser.uid]){
                        _data.project.db.owners[firebase.auth().currentUser.uid]["online"]=true;
                        editor.onDidChangeModelContent(function (editor_value) {
                            if (applyingDeltas) {
                                return;
                            }
                            _data.project.db.update({
                                content: editor.getValue()
                            });
                        
                            _data.queueRef.child(Date.now().toString() + ":" + Math.random().toString().slice(2)).set({
                                // Store the data we get from monaco editor
                                event: editor_value,
                                // Store the editor value
                                value: editor.getValue(),
                                // Store the firebase-user id
                                by: firebase.auth().currentUser.uid
                            }).catch(function(e) {
                                // In case of errors, we want to see them in the console
                                console.error(e)
                            });
                        });
                        editor.onDidChangeCursorSelection((value)=>{
                            if (applyingDeltas) {
                                return;
                            }
                            _data.cursor.child(Date.now().toString() + ":" + Math.random().toString().slice(2)).set({
                                // Store the data we get from monaco editor
                                event: value,
                                // Store the editor value
                                value: value.selection,
                                // Store the firebase-user id
                                by: firebase.auth().currentUser.uid
                            }).catch(function(e) {
                                // In case of errors, we want to see them in the console
                                console.error(e)
                            });
                        });
                        window.onbeforeunload = function () {
                            _data.project.db.owners[firebase.auth().currentUser.uid]["online"]=false;
                        }
                    }
                    _data.queueRef.on("child_added", function (ref) {

                        // Get the timestamp
                        var timestamp = ref.key.split(":")[0];

                        // Do not apply changes from the past
                        if (lastRef < timestamp) {
                            return;
                        }

                        // Get the snapshot value
                        var value = ref.val();
                        
                        // In case it's me who changed the value, I am
                        // not interested to see twice what I'm writing.
                        // So, if the update is made by me, it doesn't
                        // make sense to apply the update
                        if (value.by === firebase.auth().currentUser.uid) { return; }
                    
                        // We're going to apply the changes by somebody else in our editor
                        //  1. We turn applyingDeltas on
                        applyingDeltas = true;
                        //  2. Update the editor value with the event data
                        editor.setValue(value.value);
                        //  3. Turn off the applyingDeltas
                        applyingDeltas = false;
                        //  4. Log the event to console
                        console.log(value.event);
                        
                        lastRef = Date.now().toString()
                    });
                    _data.cursor.on("child_added", function (ref) {

                        // Get the timestamp
                        var timestamp = ref.key.split(":")[0];

                        // Do not apply changes from the past
                        if (lastCursor < timestamp) {
                            return;
                        }

                        // Get the snapshot value
                        var value = ref.val();
                        
                        // In case it's me who changed the value, I am
                        // not interested to see twice what I'm writing.
                        // So, if the update is made by me, it doesn't
                        // make sense to apply the update
                        if (value.by === firebase.auth().currentUser.uid) { return; }
                    
                        // We're going to apply the changes by somebody else in our editor
                        //  1. We turn applyingDeltas on
                        applyingDeltas = true;
                        //  2. Update the editor value with the event data
                        //    1. highlight value.value.startLineNumber, value.value.startColumn to value.value.endLineNumber, value.value.endColumn with orange,green, etc.
                        //    2. show cursor at value.value.positionLineNumber, value.value.positionColumn
                        //    3. show a name tag over it when it moves
                        //  3. Turn off the applyingDeltas
                        applyingDeltas = false;
                        //  4. Log the event to console
                        console.log(value.event);
                        
                        lastCursor = Date.now().toString()
                    });
                }
            });
        }
        init_firebase()
        init_editor();
    </script>
</body>

</html>
