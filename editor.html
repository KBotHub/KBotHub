<!DOCTYPE html>
<html lang="kr">

<head>
    <meta charset="utf-8">
    <title>KBotHub</title>
    <link rel="shortcut icon" type="image/jpg" href="https://kboteditor.kro.kr/img/output-onlinepngtools.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kboteditor.kro.kr/">
    <meta property="og:title" content="KakaotalkBot Hub">
    <meta property="og:description" content="카카오톡 봇 허브입니다.">
    <meta property="og:image" content="https://kboteditor.kro.kr/img/grp_img.jpg">
    <meta name="description" content="봇 허브 입니다">
    <meta name="keywords" content="온라인 메신저봇">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://kboteditor.kro.kr/fonts/fonts.css">
    <link rel="stylesheet" href="https://kboteditor.kro.kr/css/Toast.min.css">
    <script src="https://kboteditor.kro.kr/js/Toast.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.0/anime.min.js" integrity="sha512-LfB+BcvR3zBt7ebVskhSWiSbEUiG3p5EcCprkieldsKhBeR6wpnLi0VpWC2GNgVGWP2n/skO8Bx2oKNjUhXCkw==" crossorigin="anonymous"></script>
</head>

<body>
    <style>
        html,
        body,
        #monaco_container,
        #loader,
        #main {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #252423;
            color: #F6F4F2;
        }

        .userDecoration {
            background-color: rgba(252 186 3 / 15%);
            color: white;
        }

        .lineHighlight {
            background-color: rgb(229 255 0/ 15%) !important;
        }

        .other-cursor {
            background: white;
            width: 1px !important;
            opacity: 90%;
            animation: blink-animation 1s steps(5, start) infinite;
            -webkit-animation: blink-animation 1s steps(5, start) infinite;
        }

        @keyframes blink-animation {
            to {
                visibility: hidden;
            }
        }

        @-webkit-keyframes blink-animation {
            to {
                visibility: hidden;
            }
        }

        .animation-wrapper {
            width: 50%;
            padding-bottom: 50%;
        }

        .sphere-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 580px;
            height: 580px;
            margin: -290px 0 0 -290px;
        }

        .sphere path {
            fill: url(#sphereGradient);
            stroke-width: 1px;
            stroke: rgba(80, 80, 80, .35);
            backface-visibility: hidden;
        }

        @media (min-width: 500px) {
            .sphere path {
                stroke-width: .4px;
            }
        }
    </style>
    <div class="toastjs-container" role="alert" aria-hidden="true">
        <div class="toastjs"></div>
    </div>
    <div id="loader">
        <div class="animation-wrapper">
            <div class="sphere-animation">
                <svg class="sphere" viewBox="0 0 440 440" stroke="rgba(80,80,80,.35)">
                    <defs>
                        <linearGradient id="sphereGradient" x1="5%" x2="5%" y1="0%" y2="15%">
                            <stop stop-color="#373734" offset="0%" />
                            <stop stop-color="#242423" offset="50%" />
                            <stop stop-color="#0D0D0C" offset="100%" />
                        </linearGradient>
                    </defs>
                    <path d="M361.604 361.238c-24.407 24.408-51.119 37.27-59.662 28.727-8.542-8.543 4.319-35.255 28.726-59.663 24.408-24.407 51.12-37.269 59.663-28.726 8.542 8.543-4.319 35.255-28.727 59.662z" />
                    <path d="M360.72 360.354c-35.879 35.88-75.254 54.677-87.946 41.985-12.692-12.692 6.105-52.067 41.985-87.947 35.879-35.879 75.254-54.676 87.946-41.984 12.692 12.692-6.105 52.067-41.984 87.946z" />
                    <path d="M357.185 356.819c-44.91 44.91-94.376 68.258-110.485 52.149-16.11-16.11 7.238-65.575 52.149-110.485 44.91-44.91 94.376-68.259 110.485-52.15 16.11 16.11-7.239 65.576-52.149 110.486z" />
                    <path d="M350.998 350.632c-53.21 53.209-111.579 81.107-130.373 62.313-18.794-18.793 9.105-77.163 62.314-130.372 53.209-53.21 111.579-81.108 130.373-62.314 18.794 18.794-9.105 77.164-62.314 130.373z" />
                    <path d="M343.043 342.677c-59.8 59.799-125.292 91.26-146.283 70.268-20.99-20.99 10.47-86.483 70.269-146.282 59.799-59.8 125.292-91.26 146.283-70.269 20.99 20.99-10.47 86.484-70.27 146.283z" />
                    <path d="M334.646 334.28c-65.169 65.169-136.697 99.3-159.762 76.235-23.065-23.066 11.066-94.593 76.235-159.762s136.697-99.3 159.762-76.235c23.065 23.065-11.066 94.593-76.235 159.762z" />
                    <path d="M324.923 324.557c-69.806 69.806-146.38 106.411-171.031 81.76-24.652-24.652 11.953-101.226 81.759-171.032 69.806-69.806 146.38-106.411 171.031-81.76 24.652 24.653-11.953 101.226-81.759 171.032z" />
                    <path d="M312.99 312.625c-73.222 73.223-153.555 111.609-179.428 85.736-25.872-25.872 12.514-106.205 85.737-179.428s153.556-111.609 179.429-85.737c25.872 25.873-12.514 106.205-85.737 179.429z" />
                    <path d="M300.175 299.808c-75.909 75.909-159.11 115.778-185.837 89.052-26.726-26.727 13.143-109.929 89.051-185.837 75.908-75.908 159.11-115.778 185.837-89.051 26.726 26.726-13.143 109.928-89.051 185.836z" />
                    <path d="M284.707 284.34c-77.617 77.617-162.303 118.773-189.152 91.924-26.848-26.848 14.308-111.534 91.924-189.15C265.096 109.496 349.782 68.34 376.63 95.188c26.849 26.849-14.307 111.535-91.923 189.151z" />
                    <path d="M269.239 267.989c-78.105 78.104-163.187 119.656-190.035 92.807-26.849-26.848 14.703-111.93 92.807-190.035 78.105-78.104 163.187-119.656 190.035-92.807 26.849 26.848-14.703 111.93-92.807 190.035z" />
                    <path d="M252.887 252.52C175.27 330.138 90.584 371.294 63.736 344.446 36.887 317.596 78.043 232.91 155.66 155.293 233.276 77.677 317.962 36.521 344.81 63.37c26.85 26.848-14.307 111.534-91.923 189.15z" />
                    <path d="M236.977 236.61C161.069 312.52 77.867 352.389 51.14 325.663c-26.726-26.727 13.143-109.928 89.052-185.837 75.908-75.908 159.11-115.777 185.836-89.05 26.727 26.726-13.143 109.928-89.051 185.836z" />
                    <path d="M221.067 220.7C147.844 293.925 67.51 332.31 41.639 306.439c-25.873-25.873 12.513-106.206 85.736-179.429C200.6 53.786 280.931 15.4 306.804 41.272c25.872 25.873-12.514 106.206-85.737 179.429z" />
                    <path d="M205.157 204.79c-69.806 69.807-146.38 106.412-171.031 81.76-24.652-24.652 11.953-101.225 81.759-171.031 69.806-69.807 146.38-106.411 171.031-81.76 24.652 24.652-11.953 101.226-81.759 171.032z" />
                    <path d="M189.247 188.881c-65.169 65.169-136.696 99.3-159.762 76.235-23.065-23.065 11.066-94.593 76.235-159.762s136.697-99.3 159.762-76.235c23.065 23.065-11.066 94.593-76.235 159.762z" />
                    <path d="M173.337 172.971c-59.799 59.8-125.292 91.26-146.282 70.269-20.991-20.99 10.47-86.484 70.268-146.283 59.8-59.799 125.292-91.26 146.283-70.269 20.99 20.991-10.47 86.484-70.269 146.283z" />
                    <path d="M157.427 157.061c-53.209 53.21-111.578 81.108-130.372 62.314-18.794-18.794 9.104-77.164 62.313-130.373 53.21-53.209 111.58-81.108 130.373-62.314 18.794 18.794-9.105 77.164-62.314 130.373z" />
                    <path d="M141.517 141.151c-44.91 44.91-94.376 68.259-110.485 52.15-16.11-16.11 7.239-65.576 52.15-110.486 44.91-44.91 94.375-68.258 110.485-52.15 16.109 16.11-7.24 65.576-52.15 110.486z" />
                    <path d="M125.608 125.241c-35.88 35.88-75.255 54.677-87.947 41.985-12.692-12.692 6.105-52.067 41.985-87.947C115.525 43.4 154.9 24.603 167.592 37.295c12.692 12.692-6.105 52.067-41.984 87.946z" />
                    <path d="M109.698 109.332c-24.408 24.407-51.12 37.268-59.663 28.726-8.542-8.543 4.319-35.255 28.727-59.662 24.407-24.408 51.12-37.27 59.662-28.727 8.543 8.543-4.319 35.255-28.726 59.663z" />
                </svg>
            </div>
        </div>
        <br>
        <h3 id="loader_text">loading firebase</h3>
    </div>
    <div id="main">
        <div id="monaco_container"></div>
    </div>
    <script>
        document.getElementById("loader").style.display = "block";
        document.getElementById("main").style.display = "none";

        function init_ready() {
            var delay_var = 1500;
            var fade_var = 200;

            function fitElementToParent(el, padding) {
                var timeout = null;

                function resize() {
                    if (timeout) clearTimeout(timeout);
                    anime.set(el, {
                        scale: 1
                    });
                    var pad = padding || 0;
                    var parentEl = el.parentNode;
                    var elOffsetWidth = el.offsetWidth - pad;
                    var parentOffsetWidth = parentEl.offsetWidth;
                    var ratio = parentOffsetWidth / elOffsetWidth;
                    timeout = setTimeout(anime.set(el, {
                        scale: ratio
                    }), 10);
                }
                resize();
                window.addEventListener('resize', resize);
            }

            var sphereAnimation = (function() {

                var sphereEl = document.querySelector('.sphere-animation');
                var spherePathEls = sphereEl.querySelectorAll('.sphere path');
                var pathLength = spherePathEls.length;
                var hasStarted = false;
                var aimations = [];

                fitElementToParent(sphereEl);

                var breathAnimation = anime({
                    begin: function() {
                        for (var i = 0; i < pathLength; i++) {
                            aimations.push(anime({
                                targets: spherePathEls[i],
                                stroke: {
                                    value: ['rgba(182 46 255,1)', 'rgba(80,80,80,.35)'],
                                    duration: 500
                                },
                                translateX: [2, -4],
                                translateY: [2, -4],
                                easing: 'easeOutQuad',
                                autoplay: false
                            }));
                        }
                    },
                    update: function(ins) {
                        aimations.forEach(function(animation, i) {
                            var percent = (1 - Math.sin((i * .35) + (.0022 * ins.currentTime))) / 2;
                            animation.seek(animation.duration * percent);
                        });
                    },
                    duration: Infinity,
                    autoplay: false
                });

                var introAnimation = anime.timeline({
                        autoplay: false
                    })
                    .add({
                        targets: spherePathEls,
                        strokeDashoffset: {
                            value: [anime.setDashoffset, 0],
                            duration: 3900,
                            easing: 'easeInOutCirc',
                            delay: anime.stagger(190, {
                                direction: 'reverse'
                            })
                        },
                        duration: 2000,
                        delay: anime.stagger(60, {
                            direction: 'reverse'
                        }),
                        easing: 'linear'
                    }, 0);

                var shadowAnimation = anime({
                    targets: '#sphereGradient',
                    x1: '25%',
                    x2: '25%',
                    y1: '0%',
                    y2: '75%',
                    duration: 30000,
                    easing: 'easeOutQuint',
                    autoplay: false
                }, 0);

                function init_animation() {
                    introAnimation.play();
                    breathAnimation.play();
                    shadowAnimation.play();
                }

                init_animation();

            })();
            jQuery.loadScript = function(url, callback) {
                jQuery.ajax({
                    url: url,
                    dataType: 'script',
                    success: callback,
                    async: true
                });
            }
            $.loadScript("https://www.gstatic.com/firebasejs/7.2.0/firebase-app.js", function() {
                setTimeout(function() {
                    $("#loader_text").fadeOut(fade_var)
                    document.getElementById('loader_text').innerText = "loading analytics";
                    $("#loader_text").fadeIn(fade_var)
                    $.loadScript("https://www.gstatic.com/firebasejs/7.2.0/firebase-analytics.js", function() {
                        setTimeout(function() {
                            $("#loader_text").fadeOut(fade_var)
                            document.getElementById('loader_text').innerText = "loading auth";
                            $("#loader_text").fadeIn(fade_var)
                            $.loadScript("https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js", function() {
                                setTimeout(function() {
                                    $("#loader_text").fadeOut(fade_var)
                                    document.getElementById('loader_text').innerText = "loading database";
                                    $("#loader_text").fadeIn(fade_var)
                                    $.loadScript("https://www.gstatic.com/firebasejs/7.2.0/firebase-database.js", function() {
                                        setTimeout(function() {
                                            $("#loader_text").fadeOut(fade_var)
                                            document.getElementById('loader_text').innerText = "loading performance";
                                            $("#loader_text").fadeIn(fade_var)
                                            $.loadScript("https://www.gstatic.com/firebasejs/7.2.0/firebase-performance.js", function() {
                                                setTimeout(function() {
                                                    $("#loader_text").fadeOut(fade_var)
                                                    document.getElementById('loader_text').innerText = "loading editor";
                                                    $("#loader_text").fadeIn(fade_var)
                                                    // Your web app's Firebase configuration
                                                    var firebaseConfig = {
                                                        apiKey: "AIzaSyBsvjuWiZBTEoBJWMvih4q7JHH6gmHF1X0",
                                                        authDomain: "editor-280309.firebaseapp.com",
                                                        databaseURL: "https://editor-280309.firebaseio.com",
                                                        projectId: "editor-280309",
                                                        storageBucket: "editor-280309.appspot.com",
                                                        messagingSenderId: "836598450292",
                                                        appId: "1:836598450292:web:35d0ab7d3e13faf7bba921",
                                                        measurementId: "G-RJNBM8TLLK"
                                                    };

                                                    firebase.initializeApp(firebaseConfig);
                                                    firebase.performance();
                                                    firebase.analytics();
                                                    console.log('loaded firebase');
                                                    $.loadScript("https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js", function() {
                                                        setTimeout(function() {
                                                            init_all();
                                                        }, delay_var);
                                                    });
                                                }, delay_var);
                                            });
                                        }, delay_var);
                                    });
                                }, delay_var);
                            });
                        }, delay_var);
                    });
                }, delay_var);
            });

            function init_all() {
                var editor;
                var _data = {
                    firebase: false,
                    queueRef: {},
                    cursor: {},
                    'project': {},
                    db: {},
                    user: {},
                    update: {},
                    language: ""
                };
                var applyingDeltas = false;
                var lastRef = Date.now().toString();
                var lastCursor = Date.now().toString();
                var lastUser = Date.now().toString();

                function init_firebase() {
                    if (window.innerWidth < 800) {
                        alert('mobile not supported');
                        history.back();
                        return;
                    }
                    if (!location.href.startsWith('https://kboteditor.kro.kr/editor?id=')) {
                        _data = {
                            'project': {
                                'scriptName': '스크립트 이름'
                            },
                        };
                        _data.value = [
                            'const scriptName = \"' + _data.project.scriptName + '\";',
                            '/**',
                            ' * (string) room',
                            ' * (string) sender',
                            ' * (boolean) isGroupChat',
                            ' * (void) replier.reply(message)',
                            ' * (boolean) replier.reply(room, message, hideErrorToast = false) // 전송 성공시 true, 실패시 false 반환',
                            ' * (string) imageDB.getProfileBase64()',
                            ' * (string) packageName',
                            ' */',
                            'function response(room, msg, sender, isGroupChat, replier, imageDB, packageName) {',
                            '\t//여기에 코드를 입력',
                            '}',
                            '',
                            '//아래 4개의 메소드는 액티비티 화면을 수정할때 사용됩니다.',
                            'function onCreate(savedInstanceState, activity) {',
                            '\tvar textView = new android.widget.TextView(activity);',
                            '\ttextView.setText("Hello, World!");',
                            '\ttextView.setTextColor(android.graphics.Color.DKGRAY);',
                            '\tactivity.setContentView(textView);',
                            '}',
                            '',
                            'function onStart(activity) {}',
                            '',
                            'function onResume(activity) {}',
                            '',
                            'function onPause(activity) {}',
                            '',
                            'function onStop(activity) {}'
                        ].join('\n');
                        init_editor();
                    } else if (location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split("#")[0].length != 10 || !(!isNaN(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0]) && isFinite(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0]) && Math.floor(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0]) == location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0])) {
                        _data.value = '/*\ninvalid project id\n*/';
                        init_editor();
                    } else if (!firebase.database().ref("project_data").child(location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0])) {
                        _data.value = '/*\nproject does\'t exist\n*/';
                        init_editor();
                    } else {
                        try {
                            _data.editor_id = location.href.substring('https://kboteditor.kro.kr/editor?id='.length).split('#')[0];
                            _data.project.db = firebase.database().ref("project_data").child(_data.editor_id);
                            _data.project.db.once('value').then(function(d) {
                                _data.db = d.val();
                                _data.value = decodeURIComponent(_data.db.content);
                                document.title = decodeURIComponent(_data.db.title);
                                if (_data.db.language == "js") {
                                    _data.language = 'javascript';
                                }
                                init_editor();
                            });
                            _data.firebase = true;
                            _data.queueRef = _data.project.db.child("queue");
                            _data.cursor = _data.project.db.child("cursor");
                        } catch (e) {
                            _data.value = '/*\nunknown error\n' + e + '\n*/';
                            init_editor();
                        }
                    }
                }

                function init_editor() {
                    var decorations = [];
                    if (_data.firebase) {
                        _data.project.scriptName = _data.db.title;
                    } else {
                        _data.project.scriptName = '스크립트 이름';
                    }
                    var default_data = [
                        'const scriptName = \"' + decodeURIComponent(_data.project.scriptName) + '\";',
                        '/**',
                        ' * (string) room',
                        ' * (string) sender',
                        ' * (boolean) isGroupChat',
                        ' * (void) replier.reply(message)',
                        ' * (boolean) replier.reply(room, message, hideErrorToast = false) // 전송 성공시 true, 실패시 false 반환',
                        ' * (string) imageDB.getProfileBase64()',
                        ' * (string) packageName',
                        ' */',
                        'function response(room, msg, sender, isGroupChat, replier, imageDB, packageName) {',
                        '\t//여기에 코드를 입력',
                        '}',
                        '',
                        '//아래 4개의 메소드는 액티비티 화면을 수정할때 사용됩니다.',
                        'function onCreate(savedInstanceState, activity) {',
                        '\tvar textView = new android.widget.TextView(activity);',
                        '\ttextView.setText("Hello, World!");',
                        '\ttextView.setTextColor(android.graphics.Color.DKGRAY);',
                        '\tactivity.setContentView(textView);',
                        '}',
                        '',
                        'function onStart(activity) {}',
                        '',
                        'function onResume(activity) {}',
                        '',
                        'function onPause(activity) {}',
                        '',
                        'function onStop(activity) {}'
                    ].join('\n');
                    if (!_data.language) {
                        _data.language = "javascript";
                    }
                    if (['javascript', 'typescript', 'html', 'css'].indexOf(_data.language) != -1) {
                        require.config({
                            paths: {
                                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.16.2/min/vs'
                            }
                        });
                        require(['vs/editor/editor.main'], function() {
                            editor = monaco.editor.create(document.getElementById('monaco_container'), {
                                value: _data.value,
                                language: _data.language,
                                theme: 'vs-dark',
                                fontFamily: 'JetBrainsMono-Regular',
                                automaticLayout: true
                            });
                            editor.createContextKey( /*key name*/ 'beautifier', /*default value*/ true);
                            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_B, function() {
                                editor.getAction('editor.action.formatDocument').run()
                            }, 'beautifier');
                            editor.createContextKey( /*key name*/ 'DEFAULT-JS', /*default value*/ true);
                            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_D, function() {
                                editor.setValue(default_data)
                            }, 'DEFAULT-JS');
                            console.log('loaded monaco');
                            if (_data.firebase) {

                                if (location.href.substring(location.href.split('#')[0].length).startsWith('#L') && isFinite(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0])) && !isNaN(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]))) {
                                    //L111 or L1-12 일때 이동, 하이라이팅
                                    if (location.href.substring(location.href.split('#')[0].length + 2).split("-").length == 1) {
                                        editor.revealPositionInCenter({
                                            lineNumber: Number(location.href.substring(location.href.split('#')[0].length + 2)),
                                            column: 1
                                        });
                                        editor.deltaDecorations([], [{
                                            range: new monaco.Range(Number(location.href.substring(location.href.split('#')[0].length + 2)), 1, Number(location.href.substring(location.href.split('#')[0].length + 2)), editor.getValue().split('\n')[Number(location.href.substring(location.href.split('#')[0].length + 2) - 1)].length + 1),
                                            options: {
                                                inlineClassName: 'lineHighlight'
                                            }
                                        }, ]);
                                    } else if (location.href.substring(location.href.split('#')[0].length + 2).split("-").length == 2 && isFinite(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1])) && !isNaN(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1]))) {
                                        if (Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]) < Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1])) {
                                            editor.revealPositionInCenter({
                                                lineNumber: Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]),
                                                column: 1
                                            });
                                            editor.deltaDecorations([], [{
                                                range: new monaco.Range(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]), 1, Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1]), editor.getValue().split('\n')[Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1]) - 1].length + 1),
                                                options: {
                                                    inlineClassName: 'lineHighlight'
                                                }
                                            }, ]);
                                        } else {
                                            editor.revealPositionInCenter({
                                                lineNumber: Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1]),
                                                column: 1
                                            });
                                            editor.deltaDecorations([], [{
                                                range: new monaco.Range(Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[1]), 1, Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]), editor.getValue().split('\n')[Number(location.href.substring(location.href.split('#')[0].length + 2).split("-")[0]) - 1].length + 1),
                                                options: {
                                                    inlineClassName: 'lineHighlight'
                                                }
                                            }, ]);
                                        }
                                    }
                                }
                                if (!!firebase.auth().currentUser) {
                                    if (_data.db.type == "private") {
                                        if (!!_data.db.owners[firebase.auth().currentUser.uid]) {
                                            _data.user = _data.project.db.child("owners");

                                            _data.project.db.once('value').then(function(d) {
                                                _data.db = d.val();
                                                if (_data.db.owners[firebase.auth().currentUser.uid]["online"] == true) {
                                                    alert('동시 접속이 불가능합니다');
                                                    history.back();
                                                }

                                                $.get('https://www.cloudflare.com/cdn-cgi/trace', function(data) {
                                                    _data.user.child(firebase.auth().currentUser.uid).set({
                                                        "online": true,
                                                        "name": firebase.auth().currentUser.displayName,
                                                        "proflie": firebase.auth().currentUser.photoURL,
                                                        "email": firebase.auth().currentUser.email,
                                                        "by": firebase.auth().currentUser.uid,
                                                        "user_data": encodeURIComponent(data)
                                                    });
                                                })
                                            });
                                            _data.user.update({
                                                online: _data.db.owners.online + "," + firebase.auth().currentUser.uid
                                            });
                                            editor.onDidChangeModelContent(function(editor_value) {
                                                if (applyingDeltas) {
                                                    return;
                                                }
                                                var timeStamp = Date.now().toString() + ":" + Math.random().toString().slice(2);
                                                _data.project.db.update({
                                                    content: encodeURIComponent(editor.getValue())
                                                });
                                                _data.project.db.once('value').then(function(d) {
                                                    if (typeof d.val().length != undefined) {
                                                        if (d.val().queue.length > 20) {
                                                            _data.project.db.set({
                                                                queue: d.val().shift()
                                                            })
                                                        }
                                                    } else {
                                                        _data.project.db.set({
                                                            queue: [""]
                                                        })
                                                    }

                                                    _data.project.db.set({
                                                        queue: d.val().queue.push({

                                                            //timestamp
                                                            ts: timeStamp,
                                                            // Store the data we get from monaco editor
                                                            event: editor_value,
                                                            // Store the firebase-user id
                                                            by: firebase.auth().currentUser.uid
                                                        })
                                                    }).catch(function(e) {
                                                        // In case of errors, we want to see them in the console
                                                        console.error(e)
                                                    });
                                                })
                                            });
                                            editor.onDidChangeCursorSelection((value) => {
                                                if (applyingDeltas) {
                                                    return;
                                                }
                                                _data.cursor.update({
                                                    //timestamp
                                                    ts: Date.now().toString() + ":" + Math.random().toString().slice(2),
                                                    // Store the data we get from monaco editor
                                                    event: value,
                                                    // Store the editor value
                                                    value: value.selection,
                                                    // Store the firebase-user id
                                                    by: firebase.auth().currentUser.uid
                                                }).catch(function(e) {
                                                    // In case of errors, we want to see them in the console
                                                    console.error(e)
                                                });
                                            });
                                            window.onbeforeunload = function() {
                                                _data.user.child(firebase.auth().currentUser.uid).update({
                                                    "online": false
                                                });
                                                _data.user.once('value').then(function(d) {
                                                    if (d.val().online.replaceAll("," + firebase.auth().currentUser.uid, "").replaceAll(",", "").replaceAll("undefined", "") == "") {
                                                        _data.project.db.update({
                                                            content: encodeURIComponent(editor.getValue())
                                                        });
                                                        _data.project.db.update({
                                                            queue: ""
                                                        });
                                                    }
                                                    _data.user.update({
                                                        online: d.val().online.replaceAll("," + firebase.auth().currentUser.uid, "")
                                                    });
                                                });
                                            }
                                        } else {
                                            editor.setValue("/*\nthis is a private project\n*/");
                                        }
                                    } else if (_data.db.type == "public") {
                                        _data.user = _data.project.db.child("users");
                                        if (!_data.db.users[firebase.auth().currentUser.uid]) {
                                            $.get('https://www.cloudflare.com/cdn-cgi/trace', function(data) {
                                                _data.user.child(firebase.auth().currentUser.uid).set({
                                                    "online": false,
                                                    "name": firebase.auth().currentUser.displayName,
                                                    "proflie": firebase.auth().currentUser.photoURL,
                                                    "email": firebase.auth().currentUser.email,
                                                    "by": firebase.auth().currentUser.uid,
                                                    "user_data": encodeURIComponent(data)
                                                });
                                            })
                                        }
                                        _data.project.db.once('value').then(function(d) {
                                            _data.db = d.val();
                                            if (_data.db.users[firebase.auth().currentUser.uid]["online"] == true) {
                                                alert('동시 접속이 불가능합니다');
                                                history.back();
                                            }

                                            $.get('https://www.cloudflare.com/cdn-cgi/trace', function(data) {
                                                _data.user.child(firebase.auth().currentUser.uid).set({
                                                    "online": true,
                                                    "name": firebase.auth().currentUser.displayName,
                                                    "proflie": firebase.auth().currentUser.photoURL,
                                                    "email": firebase.auth().currentUser.email,
                                                    "by": firebase.auth().currentUser.uid,
                                                    "user_data": encodeURIComponent(data)
                                                });
                                            })
                                        });
                                        _data.user.update({
                                            online: _data.db.users.online + "," + firebase.auth().currentUser.uid
                                        });
                                        editor.onDidChangeModelContent(function(editor_value) {
                                            if (applyingDeltas) {
                                                return;
                                            }
                                            var timeStamp = Date.now().toString() + ":" + Math.random().toString().slice(2);
                                            _data.project.db.update({
                                                content: encodeURIComponent(editor.getValue())
                                            });
                                            _data.project.db.once('value').then(function(d) {
                                                if (typeof d.val().length != undefined) {
                                                    if (d.val().queue.length > 20) {
                                                        _data.project.db.set({
                                                            queue: d.val().shift()
                                                        })
                                                    }
                                                } else {
                                                    _data.project.db.set({
                                                        queue: [""]
                                                    })
                                                }
                                                
                                                console.log(d.val())

                                                _data.project.db.set({
                                                    /*queue: d.val().queue.push({

                                                        //timestamp
                                                        ts: timeStamp,
                                                        // Store the data we get from monaco editor
                                                        event: editor_value,
                                                        // Store the firebase-user id
                                                        by: firebase.auth().currentUser.uid
                                                    })*/
                                                }).catch(function(e) {
                                                    // In case of errors, we want to see them in the console
                                                    console.error(e)
                                                });
                                            })
                                        });
                                        editor.onDidChangeCursorSelection((value) => {
                                            if (applyingDeltas) {
                                                return;
                                            }
                                            _data.cursor.update({
                                                //timestamp
                                                ts: Date.now().toString() + ":" + Math.random().toString().slice(2),
                                                // Store the data we get from monaco editor
                                                event: value,
                                                // Store the editor value
                                                value: value.selection,
                                                // Store the firebase-user id
                                                by: firebase.auth().currentUser.uid
                                            }).catch(function(e) {
                                                // In case of errors, we want to see them in the console
                                                console.error(e)
                                            });
                                        });
                                        window.onbeforeunload = function() {
                                            _data.user.child(firebase.auth().currentUser.uid).update({
                                                "online": false
                                            });
                                            _data.user.once('value').then(function(d) {
                                                if (d.val().online.replaceAll("," + firebase.auth().currentUser.uid, "").replaceAll(",", "").replaceAll("undefined", "") == "") {
                                                    _data.project.db.update({
                                                        content: encodeURIComponent(editor.getValue())
                                                    });
                                                    _data.project.db.update({
                                                        queue: ""
                                                    });
                                                }
                                                _data.user.update({
                                                    online: d.val().online.replaceAll("," + firebase.auth().currentUser.uid, "")
                                                });
                                            });
                                        }
                                    }
                                    _data.queueRef.on("child_changed", function(ref) {
                                        if (!ref || !ref.val() || !ref.val().ts) return;

                                        // Get the snapshot value
                                        var value = ref.val().reverse()[0];

                                        // Get the timestamp
                                        var timestamp = value.ts.split(":")[0];

                                        // Do not apply changes from the past
                                        if (lastCursor > timestamp) {
                                            return;
                                        }

                                        // In case it's me who changed the value, I am
                                        // not interested to see twice what I'm writing.
                                        // So, if the update is made by me, it doesn't
                                        // make sense to apply the update
                                        if (value.by == firebase.auth().currentUser.uid) {
                                            return;
                                        }

                                        // We're going to apply the changes by somebody else in our editor
                                        //  1. We turn applyingDeltas on
                                        applyingDeltas = true;
                                        //  2. Update the editor value with the event data
                                        editor.executeEdits("", [value.event.changes[0]]);
                                        //  3. Turn off the applyingDeltas
                                        applyingDeltas = false;
                                        //  4. Log the event to console

                                        lastRef = Date.now().toString();

                                        _data.project.db.once('value').then(function(d) {
                                            if (d.val().content != encodeURIComponent(editor.getValue())) {
                                                alert("통신상태가 원활하지 않습니다.");
                                                location.href = location.href;
                                            }
                                        })

                                    });

                                    _data.cursor.on("child_changed", function(ref) {
                                        _data.cursor.once('value').then(function(d) {
                                            var value = d.val();

                                            // Get the timestamp
                                            var timestamp = value.ts.split(":")[0];

                                            // Do not apply changes from the past
                                            if (lastCursor > timestamp) {
                                                return;
                                            }

                                            // In case it's me who changed the value, I am
                                            // not interested to see twice what I'm writing.
                                            // So, if the update is made by me, it doesn't
                                            // make sense to apply the update
                                            if (value.by === firebase.auth().currentUser.uid) {
                                                return;
                                            }

                                            // We're going to apply the changes by somebody else in our editor
                                            //  1. We turn applyingDeltas on
                                            applyingDeltas = true;
                                            //  2. Update the editor value with the event data
                                            decorations = editor.deltaDecorations(decorations, [{
                                                range: new monaco.Range(1, 1, 1, 1),
                                                options: {
                                                    inlineClassName: 'userDecoration'
                                                }
                                            }]);
                                            if (value.value.startLineNumber < value.value.endLineNumber) {
                                                decorations = editor.deltaDecorations(decorations, [
                                                    //    1. highlight value.value.startLineNumber, value.value.startColumn to value.value.endLineNumber, value.value.endColumn with orange,green, etc.
                                                    {
                                                        range: new monaco.Range(value.value.startLineNumber, value.value.startColumn, value.value.endLineNumber, value.value.endColumn),
                                                        options: {
                                                            inlineClassName: 'userDecoration'
                                                        }
                                                    },
                                                    //    2. show cursor at value.value.positionLineNumber, value.value.positionColumn
                                                    {
                                                        range: new monaco.Range(value.value.positionLineNumber, value.value.positionColumn, value.value.positionLineNumber, value.value.positionColumn),
                                                        options: {
                                                            className: 'other-cursor'
                                                        }
                                                    },
                                                    //    3. show a name tag over it when it moves
                                                ]);
                                            } else {
                                                decorations = editor.deltaDecorations(decorations, [
                                                    //    1. highlight value.value.startLineNumber, value.value.startColumn to value.value.endLineNumber, value.value.endColumn with orange,green, etc.
                                                    {
                                                        range: new monaco.Range(value.value.endLineNumber, value.value.endColumn, value.value.startLineNumber, value.value.startColumn),
                                                        options: {
                                                            inlineClassName: 'userDecoration'
                                                        }
                                                    },
                                                    //    2. show cursor at value.value.positionLineNumber, value.value.positionColumn
                                                    {
                                                        range: new monaco.Range(value.value.positionLineNumber, value.value.positionColumn, value.value.positionLineNumber, value.value.positionColumn),
                                                        options: {
                                                            className: 'other-cursor'
                                                        }
                                                    },
                                                    //    3. show a name tag over it when it moves
                                                ]);
                                            }
                                            //  3. Turn off the applyingDeltas
                                            applyingDeltas = false;
                                            //  4. Log the event to console
                                            console.log(value.event);

                                            lastCursor = Date.now().toString();
                                        });
                                    });
                                    if (!!_data.user.on) {
                                        _data.user.on("child_changed", function(ref) {

                                            // Get the timestamp
                                            var timestamp = ref.key.split(":")[0];

                                            // Do not apply changes from the past
                                            if (lastUser > timestamp) {
                                                return;
                                            }

                                            // Get the snapshot value
                                            var value = ref.val();

                                            // In case it's me who changed the value, I am
                                            // not interested to see twice what I'm writing.
                                            // So, if the update is made by me, it doesn't
                                            // make sense to apply the update
                                            if (value.by === firebase.auth().currentUser.uid) {
                                                return;
                                            }

                                            if (value.online == true) {
                                                new Toast({
                                                    message: value.name + " joined"
                                                })
                                            } else if (value.online == false) {
                                                new Toast({
                                                    message: value.name + " left"
                                                })
                                            }

                                            console.log(value)
                                            lastUser = Date.now().toString()
                                        });
                                    }
                                }
                            }
                        });
                    }
                    document.getElementById('loader_text').innerText = "almost done";
                    setTimeout(function() {
                        document.getElementById('loader_text').innerText += "."
                        setTimeout(function() {
                            document.getElementById('loader_text').innerText += "."
                            setTimeout(function() {
                                document.getElementById('loader_text').innerText += "."
                                setTimeout(function() {
                                    $("#loader").fadeOut('normal', function() {
                                        $("#main").fadeIn()
                                    })
                                }, delay_var);
                            }, 750);
                        }, 750);
                    }, 750);
                }
                init_firebase()
            }
        }
        init_ready();
    </script>
</body>

</html>
